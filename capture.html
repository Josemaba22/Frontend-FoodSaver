<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FoodSaver - Capturar Mandado</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
</head>

<body>
    <header>
        <nav class="navbar">
            <ul>
                <li><a href="capture.html" class="nav-link" id="nav-registrar">Registrar</a></li>
                <li><a href="inventory.html" class="nav-link" id="nav-inventario">Inventario</a></li>
                <li><a href="recipes.html" class="nav-link" id="nav-recetas">Recetas</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        
        <div class="hero">
            <h2>Capturar foto del mandado</h2>
            <p class="muted">Toma una foto de los alimentos sobre la mesa. <br>El modelo propondr谩 detecciones para confirmar.
            </p>
            <div class="preview" id="preview">
                <video id="video" width="320" height="240" autoplay></video>
                <canvas id="canvas" width="224" height="224" style="display:none;"></canvas>
            </div>

            <div class="controls">
                <button id="snap">CAPTURA FOTO</button>
                <button id="switchCamera" class="btn-secondary">
                    <span id="cameraIcon"></span> 
                    <span id="cameraLabel">C谩mara trasera</span>
                </button>
            </div>

            <!-- Hidden form for file upload -->
            <form id="uploadForm" style="display:none;">
                <input type="file" id="fileInput" name="file" accept="image/*">
            </form>
        </div>

        <div id="results" style="margin-top:18px;display:none">
            <h3>Predicciones</h3>
            <ul id="predList"></ul>
            <div style="margin-top:12px">
                <a class="btn" href="confirm.html">Confirmar detecci贸n (ir a modal)</a>
            </div>
        </div>

        <!-- Modal de detecci贸n -->
        <div id="detectionModal" class="modal">
            <div class="modal-content">
                <div class="modal-body">
                    <h3 class="modal-title">Alimento detectado</h3>
                    <div class="food-preview">
                        <div class="food-image">
                            <img id="capturedImage" src="" alt="Imagen capturada">
                        </div>
                        <div class="food-info">
                            <p><strong>Nombre:</strong> <span id="foodName">Tomate</span></p>
                            <p><strong>Categor铆a:</strong> <span id="foodCategory">Vegetales</span></p>
                            <p><strong>Caducidad:</strong> <span id="foodExpiry">20/09/2025</span></p>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-cancel" id="cancelBtn">Cancelar</button>
                        <button class="btn btn-edit" id="editBtn">Editar</button>
                        <button class="btn btn-ok" id="okBtn">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const snapBtn = document.getElementById('snap');
        const resultsEl = document.getElementById('results');
        const predList = document.getElementById('predList');

        // Detectar la p谩gina actual y activar la clase correspondiente
        const path = window.location.pathname.split("/").pop();

        if (path.includes("capture") || path.includes("manual") || path.includes("confirm")) {
            document.getElementById("nav-registrar").classList.add("active");
        } else if (path.includes("inventory")) {
            document.getElementById("nav-inventario").classList.add("active");
        } else if (path.includes("recipes")) {
            document.getElementById("nav-recetas").classList.add("active");
        }

        // Access the camera with mobile support
        const video = document.getElementById('video');
        let currentStream = null;
        let facingMode = 'environment'; // 'user' for front camera, 'environment' for back camera

        // Function to start camera with specified facing mode
        async function startCamera(facing = 'environment') {
            try {
                // Stop current stream if exists
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Camera constraints with mobile support
                const constraints = {
                    video: {
                        facingMode: facing,
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                currentStream = stream;
                facingMode = facing;
            } catch (error) {
                console.error('Error accessing camera:', error);
                // Fallback: try without facingMode constraint
                try {
                    const fallbackConstraints = { video: true };
                    const stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    video.srcObject = stream;
                    currentStream = stream;
                } catch (fallbackError) {
                    console.error('Camera access failed:', fallbackError);
                    alert('No se pudo acceder a la c谩mara. Verifica los permisos.');
                }
            }
        }

        // Initialize camera
        startCamera('environment');

        // Switch camera button
        document.getElementById('switchCamera').onclick = function() {
            const newFacing = facingMode === 'environment' ? 'user' : 'environment';
            startCamera(newFacing);
            
            // Update button text and icon
            const cameraIcon = document.getElementById('cameraIcon');
            const cameraLabel = document.getElementById('cameraLabel');
            
            if (newFacing === 'user') {
                cameraIcon.textContent = 'こ';
                cameraLabel.textContent = 'C谩mara frontal';
            } else {
                cameraIcon.textContent = '';
                cameraLabel.textContent = 'C谩mara trasera';
            }
        };

        // Take photo
        const canvas = document.getElementById('canvas');
        document.getElementById('snap').onclick = async function () {
            // Dibujar la imagen en el canvas
            canvas.getContext('2d').drawImage(video, 0, 0, 224, 224);

            // Mostrar el modal con la imagen capturada
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            document.getElementById('capturedImage').src = imageDataUrl;
            
            // Mostrar loading en el modal
            document.getElementById('foodName').textContent = 'Detectando...';
            document.getElementById('foodCategory').textContent = 'Analizando imagen...';
            document.getElementById('foodExpiry').textContent = 'Calculando...';
            
            // Mostrar el modal
            document.getElementById('detectionModal').style.display = 'block';

            // Enviar imagen al endpoint de predicci贸n
            try {
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('file', blob, 'capture.jpg');

                    const response = await fetch(getApiUrl('PREDICT_IMAGE'), {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const prediction = await response.json();
                    
                    if (prediction.success) {
                        // Mapear categor铆as bas谩ndose en los alimentos que detecta el modelo
                        const categoryMap = {
                            // Frutas
                            'manzana': 'Frutas',
                            'banana': 'Frutas',
                            'uvas': 'Frutas',
                            'kiwi': 'Frutas',
                            'limon': 'Frutas',
                            'mango': 'Frutas',
                            'naranja': 'Frutas',
                            'pera': 'Frutas',
                            'pina': 'Frutas',
                            'granada': 'Frutas',
                            'sandia': 'Frutas',
                            
                            // Verduras/Vegetales
                            'remolacha': 'Verduras',
                            'pimiento': 'Verduras',
                            'repollo': 'Verduras',
                            'pimiento_rojo': 'Verduras',
                            'zanahoria': 'Verduras',
                            'coliflor': 'Verduras',
                            'chile': 'Verduras',
                            'maiz': 'Verduras',
                            'pepino': 'Verduras',
                            'berenjena': 'Verduras',
                            'ajo': 'Verduras',
                            'jengibre': 'Verduras',
                            'jalapeno': 'Verduras',
                            'lechuga': 'Verduras',
                            'cebolla': 'Verduras',
                            'paprika': 'Verduras',
                            'guisantes': 'Verduras',
                            'papa': 'Verduras',
                            'rabano': 'Verduras',
                            'soja': 'Verduras',
                            'espinaca': 'Verduras',
                            'maiz_dulce': 'Verduras',
                            'camote': 'Verduras',
                            'tomate': 'Verduras',
                            'nabo': 'Verduras'
                        };

                        const category = categoryMap[prediction.class_name.toLowerCase()] || 'Verduras';
                        
                        // Calcular fecha de caducidad (2 d铆as desde hoy)
                        const today = new Date();
                        const expiryDate = new Date(today);
                        expiryDate.setDate(today.getDate() + 2);
                        const expiryString = expiryDate.toLocaleDateString('es-ES');

                        // Actualizar la informaci贸n en el modal con datos reales
                        document.getElementById('foodName').textContent = prediction.class_name;
                        document.getElementById('foodCategory').textContent = category;
                        document.getElementById('foodExpiry').textContent = expiryString;
                        
                        console.log('Predicci贸n exitosa:', prediction);
                    } else {
                        throw new Error('Predicci贸n fallida');
                    }
                }, 'image/jpeg');
            } catch (error) {
                console.error('Error en la predicci贸n:', error);
                
                // Mostrar datos de ejemplo si falla la predicci贸n
                const fallbackFood = {
                    name: 'Alimento no identificado',
                    category: 'Verduras',
                    expiry: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES')
                };
                
                document.getElementById('foodName').textContent = fallbackFood.name;
                document.getElementById('foodCategory').textContent = fallbackFood.category;
                document.getElementById('foodExpiry').textContent = fallbackFood.expiry;
                
                // Mostrar mensaje de error (opcional)
                alert('No se pudo conectar al servidor de predicci贸n. Mostrando datos de ejemplo.');
            }
        };

        fileInput.addEventListener('change', (ev) => {
            const f = ev.target.files[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            preview.innerHTML = '<img src="' + url + '" alt="preview">';
        });

        // Modal functionality
        const modal = document.getElementById('detectionModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const editBtn = document.getElementById('editBtn');
        const okBtn = document.getElementById('okBtn');

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Cancel button functionality
        cancelBtn.onclick = function() {
            modal.style.display = 'none';
        }

        // Edit button functionality
        editBtn.onclick = function() {
            // Guardar la imagen capturada en sessionStorage
            const imageDataUrl = document.getElementById('capturedImage').src;
            sessionStorage.setItem('capturedImage', imageDataUrl);
            
            // Guardar los datos detectados para prellenar el formulario
            const detectedData = {
                name: document.getElementById('foodName').textContent,
                category: document.getElementById('foodCategory').textContent,
                expiry: document.getElementById('foodExpiry').textContent,
                expiryDate: document.getElementById('foodExpiry').textContent
            };
            sessionStorage.setItem('detectedData', JSON.stringify(detectedData));
            
            // Redirigir a manual.html para editar
            window.location.href = 'manual.html';
        }

        // OK button functionality
        okBtn.onclick = async function() {
            try {
                // Crear FormData para enviar imagen y datos
                const formData = new FormData();
                
                // Agregar campos del formulario
                formData.append('name', document.getElementById('foodName').textContent);
                formData.append('category_id', document.getElementById('foodCategory').textContent === 'Frutas' ? '2' : '1');
                formData.append('admission_date', new Date().toISOString().slice(0, 10));
                
                // Convertir la imagen del canvas a blob y agregarla
                canvas.toBlob(async (blob) => {
                    formData.append('image', blob, 'captured_food.jpg');

                    // Enviar al nuevo endpoint
                    const response = await fetch(getApiUrl('SAVE_FOOD_WITH_IMAGE'), {
                        method: 'POST',
                        body: formData // No agregamos Content-Type header, el browser lo maneja autom谩ticamente para FormData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('Alimento guardado exitosamente:', result);
                    
                    // Mostrar mensaje de 茅xito
                    alert('隆Alimento guardado exitosamente en el inventario!');
                    
                    // Cerrar modal
                    modal.style.display = 'none';
                    
                    // Redirigir al inventario para ver el alimento agregado
                    window.location.href = 'inventory.html';
                    
                }, 'image/jpeg');
                
            } catch (error) {
                console.error('Error al guardar el alimento:', error);
                alert('Error al guardar el alimento. Por favor intenta nuevamente.');
            }
        }

        // Clean up camera stream when leaving the page
        window.addEventListener('beforeunload', function() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });

        // Clean up on page visibility change (mobile)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            } else if (!document.hidden && !currentStream) {
                startCamera(facingMode);
            }
        });
    </script>
</body>

</html>