<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FoodSaver - Inventario</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
</head>

<body>
    <header>
        <nav class="navbar">
            <ul>
                <li><a href="capture.html" class="nav-link" id="nav-registrar">Registrar</a></li>
                <li><a href="inventory.html" class="nav-link" id="nav-inventario">Inventario</a></li>
                <li><a href="recipes.html" class="nav-link" id="nav-recetas">Recetas</a></li>
            </ul>
        </nav>
    </header>

    <main class="wrap">
        <h3>Mi despensa</h3>
        <div class="list" id="list">
            <!-- elementos generados por JS -->
        </div>
    </main>

    <script>
        // Detectar la página actual y activar la clase correspondiente
        const path = window.location.pathname.split("/").pop();

        if (path.includes("capture") || path.includes("manual") || path.includes("confirm")) {
            document.getElementById("nav-registrar").classList.add("active");
        } else if (path.includes("inventory")) {
            document.getElementById("nav-inventario").classList.add("active");
        } else if (path.includes("recipes")) {
            document.getElementById("nav-recetas").classList.add("active");
        }
        
        // Función para cargar datos del endpoint
        async function loadInventory() {
            try {
                const response = await fetch(getApiUrl('GET_ALL_FOODS'));
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const foods = await response.json();
                console.log('Foods data from API:', foods);
                displayInventory(foods);
            } catch (error) {
                console.error('Error al cargar el inventario:', error);
                // Mostrar datos de ejemplo si falla la conexión
                const sample = [
                    { id: 1, name: 'Tomate', days_left: 2, cat: 'Verduras' },
                    { id: 2, name: 'Leche', days_left: 1, cat: 'Lácteos' },
                    { id: 3, name: 'Pan', days_left: 3, cat: 'Panificados' }
                ];
                displayInventory(sample);
                
                // Mostrar mensaje de error al usuario
                const list = document.getElementById('list');
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 6px; margin-bottom: 16px; color: #856404;';
                errorDiv.innerHTML = '⚠️ No se pudo conectar al servidor. Mostrando datos de ejemplo.';
                list.insertBefore(errorDiv, list.firstChild);
            }
        }

        // Función para mostrar el inventario
        function displayInventory(foods) {
            console.log('CONFIG object:', CONFIG);
            console.log('API_BASE_URL:', CONFIG.API_BASE_URL);
            const list = document.getElementById('list');
            list.innerHTML = ''; // Limpiar lista existente
            
            if (!foods || foods.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No hay alimentos en el inventario</div>';
                return;
            }

            foods.forEach(food => {
                const div = document.createElement('div');
                div.className = 'item';
                
                // Calcular días restantes basándose en admission_date + 2 días
                let daysLeft = 'Sin fecha';
                if (food.admission_date) {
                    // Calcular fecha de caducidad: admission_date + 2 días
                    const admissionDate = new Date(food.admission_date);
                    const expiryDate = new Date(admissionDate);
                    expiryDate.setDate(admissionDate.getDate() + 2);
                    
                    const today = new Date();
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    daysLeft = diffDays > 0 ? `${diffDays} días restantes` : `Caducado hace ${Math.abs(diffDays)} días`;
                }
                
                // Obtener nombre de categoría de la estructura anidada
                const categoryName = food.category?.name || 'Sin categoría';
                
                // Crear imagen con fallback local
                const imageUrl = food.image_url ? `${CONFIG.API_BASE_URL}${food.image_url}` : null;
                console.log('Food:', food.name);
                console.log('  - Raw image_url:', food.image_url);
                console.log('  - Full image URL:', imageUrl);
                console.log('  - Admission date:', food.admission_date);
                
                const imageHtml = imageUrl 
                    ? `<img src="${imageUrl}" alt="${food.name}" style="width: 64px; height: 64px; object-fit: cover; border-radius: 6px;" 
                            onerror="console.error('❌ Error loading image for ${food.name}:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';" 
                            onload="console.log('✅ Image loaded successfully for ${food.name}:', this.src);" />
                       <div style="width: 64px; height: 64px; background: #f0f0f0; border-radius: 6px; display: none; align-items: center; justify-content: center; font-size: 10px; color: #999;">IMG</div>`
                    : `<div style="width: 64px; height: 64px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999;">SIN IMG</div>`;
                
                div.innerHTML = `
                    <div class="thumb">${imageHtml}</div>
                    <div class="meta">
                        <div style="font-weight:700">${food.name}</div>
                        <div class="muted">${categoryName} • ${daysLeft}</div>
                    </div>
                    <div style="margin-left: auto;"><button class="btn" onclick="useItem(${food.id})">Usar</button></div>
                `;
                list.appendChild(div);
            });
        }

        // Cargar inventario al cargar la página
        loadInventory();

        async function useItem(id) {
            // Confirmar antes de eliminar
            const confirmed = confirm('¿Estás seguro de que quieres marcar este alimento como usado? Se eliminará del inventario.');
            if (!confirmed) return;

            try {
                // Llamar al endpoint DELETE
                const response = await fetch(`${CONFIG.API_BASE_URL}/foods/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Mostrar mensaje de éxito
                alert('✅ Alimento marcado como usado y eliminado del inventario.');
                
                // Recargar el inventario para mostrar los cambios
                await loadInventory();
                
            } catch (error) {
                console.error('Error al eliminar el alimento:', error);
                alert('❌ Error al marcar el alimento como usado. Por favor intenta nuevamente.');
            }
        }

        // Función de debug para probar URLs de imagen manualmente
        window.testImageUrl = function(imageUrl) {
            const img = new Image();
            img.onload = function() {
                console.log('✅ URL de imagen accesible:', imageUrl);
            };
            img.onerror = function() {
                console.error('❌ URL de imagen NO accesible:', imageUrl);
            };
            img.src = imageUrl;
        };

        // Función de debug para mostrar info del servidor
        window.debugServerInfo = function() {
            console.log('=== DEBUG SERVER INFO ===');
            console.log('CONFIG.API_BASE_URL:', CONFIG.API_BASE_URL);
            console.log('Sample image URL test:', CONFIG.API_BASE_URL + '/media/foods/sample.jpg');
            testImageUrl(CONFIG.API_BASE_URL + '/media/foods/sample.jpg');
        };
    </script>
</body>

</html>