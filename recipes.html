<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FoodSaver - Recetas</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
</head>

<body>
    <header>
        <nav class="navbar">
            <ul>
                <li><a href="capture.html" class="nav-link" id="nav-registrar">Registrar</a></li>
                <li><a href="inventory.html" class="nav-link" id="nav-inventario">Inventario</a></li>
                <li><a href="recipes.html" class="nav-link" id="nav-recetas">Recetas</a></li>
            </ul>
        </nav>
    </header>

    <main class="wrap">
        <div class="recipes-header">
            <h2>üç≥ Recetas sugeridas</h2>
            <p class="recipes-subtitle">Recetas personalizadas basadas en los ingredientes de tu inventario</p>
        </div>
        
        <div class="recipes-actions">
            <button class="btn btn-primary" id="refreshBtn">
                <span class="btn-icon">ü§ñ</span>
                <span class="btn-text">Generar nuevas recetas con IA</span>
            </button>
            <div class="info-text">
                üí° Las recetas se guardan autom√°ticamente por 24 horas para ahorrar usos de IA
            </div>
        </div>
        
        <div id="recipes" class="recipes-grid"></div>
    </main>

    <script>
        // Detectar la p√°gina actual y activar la clase correspondiente
        const path = window.location.pathname.split("/").pop();

        if (path.includes("capture") || path.includes("manual") || path.includes("confirm")) {
            document.getElementById("nav-registrar").classList.add("active");
        } else if (path.includes("inventory")) {
            document.getElementById("nav-inventario").classList.add("active");
        } else if (path.includes("recipes")) {
            document.getElementById("nav-recetas").classList.add("active");
        }

        const recipesDiv = document.getElementById('recipes');
        let currentRecipeData = null;

        // Configuraci√≥n de cach√©
        const CACHE_KEY = 'foodsaver_recipes_cache';
        const CACHE_EXPIRY_KEY = 'foodsaver_recipes_cache_expiry';
        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas en millisegundos

        // Funci√≥n para guardar recetas en cach√©
        function saveRecipesToCache(data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                localStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
                console.log('Recetas guardadas en cach√©');
            } catch (error) {
                console.warn('No se pudo guardar en cach√©:', error);
            }
        }

        // Funci√≥n para cargar recetas desde cach√©
        function loadRecipesFromCache() {
            try {
                const cacheExpiry = localStorage.getItem(CACHE_EXPIRY_KEY);
                const now = Date.now();
                
                // Verificar si el cach√© ha expirado
                if (!cacheExpiry || now > parseInt(cacheExpiry)) {
                    console.log('Cach√© expirado');
                    return null;
                }

                const cachedData = localStorage.getItem(CACHE_KEY);
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    console.log('Recetas cargadas desde cach√©');
                    return parsed.data;
                }
            } catch (error) {
                console.warn('Error al cargar cach√©:', error);
            }
            return null;
        }

        // Funci√≥n para limpiar cach√©
        function clearRecipesCache() {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_EXPIRY_KEY);
            console.log('Cach√© de recetas limpiado');
        }

        // Funci√≥n para cargar recetas desde el endpoint o cach√©
        async function loadRecipes(forceRefresh = false) {
            // Intentar cargar desde cach√© primero (si no se fuerza refresh)
            if (!forceRefresh) {
                const cachedData = loadRecipesFromCache();
                if (cachedData) {
                    currentRecipeData = cachedData;
                    renderRecipes(cachedData.recipes);
                    displayAvailableIngredients(cachedData.source_foods);
                    //displayCacheInfo(true);
                    return;
                }
            }

            // Si no hay cach√© v√°lido o se fuerza refresh, llamar al API
            try {
                displayLoadingState(true);
                const response = await fetch(getApiUrl('GET_RECIPES_FROM_FOODS'));
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                currentRecipeData = data;
                
                // Guardar en cach√©
                saveRecipesToCache(data);
                
                renderRecipes(data.recipes);
                displayAvailableIngredients(data.source_foods);
                displayCacheInfo(false);
                
            } catch (error) {
                console.error('Error al cargar recetas:', error);
                
                // Intentar cargar desde cach√© como fallback
                const cachedData = loadRecipesFromCache();
                if (cachedData) {
                    currentRecipeData = cachedData;
                    renderRecipes(cachedData.recipes);
                    displayAvailableIngredients(cachedData.source_foods);
                    displayCacheInfo(true);
                    alert('Error al conectar con el servidor. Mostrando recetas guardadas.');
                } else {
                    // Mostrar datos de ejemplo como √∫ltimo recurso
                    renderRecipes(sampleRecipes);
                    alert('No se pudieron cargar las recetas del servidor y no hay cach√© disponible. Mostrando ejemplos.');
                }
            } finally {
                displayLoadingState(false);
            }
        }

        // Funci√≥n para mostrar/ocultar estado de carga
        function displayLoadingState(isLoading) {
            const refreshBtn = document.getElementById('refreshBtn');
            const btnIcon = refreshBtn.querySelector('.btn-icon');
            const btnText = refreshBtn.querySelector('.btn-text');
            
            if (isLoading) {
                btnIcon.textContent = '‚è≥';
                btnText.textContent = 'Generando recetas con IA...';
                refreshBtn.disabled = true;
            } else {
                btnIcon.textContent = 'ü§ñ';
                btnText.textContent = 'Generar nuevas recetas con IA';
                refreshBtn.disabled = false;
            }
        }

        // Funci√≥n para mostrar informaci√≥n del cach√©
        function displayCacheInfo(fromCache) {
            const existingInfo = document.querySelector('.cache-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'cache-info';
            infoDiv.style.cssText = `
                background: ${fromCache ? '#e3f2fd' : '#e8f5e8'}; 
                padding: 8px 12px; 
                border-radius: 4px; 
                margin-bottom: 15px; 
                font-size: 13px; 
                color: #666;
                border-left: 3px solid ${fromCache ? '#2196f3' : '#4caf50'};
            `;
            
            if (fromCache) {
                const cacheData = JSON.parse(localStorage.getItem(CACHE_KEY));
                const timeAgo = Math.round((Date.now() - cacheData.timestamp) / (1000 * 60));
                const expiryTime = new Date(parseInt(localStorage.getItem(CACHE_EXPIRY_KEY)));
                const timeUntilExpiry = Math.round((expiryTime.getTime() - Date.now()) / (1000 * 60));
                
                // Formatear tiempo de manera m√°s legible
                const formatTime = (minutes) => {
                    if (minutes < 60) return `${minutes} min`;
                    const hours = Math.round(minutes / 60);
                    return `${hours} hora${hours !== 1 ? 's' : ''}`;
                };
                
                infoDiv.innerHTML = `üì± Recetas cargadas desde cach√© local (hace ${formatTime(timeAgo)}) - Expiran en ${formatTime(timeUntilExpiry)}`;
            } else {
                infoDiv.innerHTML = `ü§ñ Recetas generadas con IA - Guardadas en cach√© por 24 horas`;
            }
            
            recipesDiv.parentNode.insertBefore(infoDiv, recipesDiv);
        }

        // Funci√≥n para mostrar ingredientes disponibles
        function displayAvailableIngredients(sourceFoods) {
            if (sourceFoods && sourceFoods.length > 0) {
                const ingredientsText = sourceFoods.map(food => food.name).join(', ');
                const existingInfo = document.querySelector('.available-ingredients');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                const ingredientsDiv = document.createElement('div');
                ingredientsDiv.className = 'available-ingredients';
                ingredientsDiv.style.cssText = 'background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #14924b;';
                ingredientsDiv.innerHTML = `
                    <strong>ü•¨ Ingredientes disponibles en tu inventario:</strong><br>
                    <span style="color: #666;">${ingredientsText}</span>
                `;
                recipesDiv.parentNode.insertBefore(ingredientsDiv, recipesDiv);
            }
        }

        const sampleRecipes = [
            {
                title: 'S√°ndwich de Tomate y Queso',
                ingredients: ['Tomate', 'Queso', 'Pan'],
                instructions: 'Cortar tomate y queso. Colocar en pan. Tostar si se desea.'
            },
            {
                title: 'Sopa de Cebolla',
                ingredients: ['Cebolla', 'Caldo', 'Pan'],
                instructions: 'Caramelizar cebolla. Agregar caldo y hervir. Servir con pan.'
            }
        ];

        function renderRecipes(recipes) {
            recipesDiv.innerHTML = '';
            
            if (!recipes || recipes.length === 0) {
                recipesDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üçΩÔ∏è</div>
                        <h3 style="color: #34495e; margin-bottom: 8px;">No hay recetas disponibles</h3>
                        <p>Agrega algunos alimentos a tu inventario para generar recetas personalizadas</p>
                    </div>
                `;
                return;
            }
            
            recipes.forEach((r, index) => {
                const el = document.createElement('div');
                el.className = 'recipe';
                el.style.animationDelay = `${index * 0.1}s`;
                
                const difficultyLevel = r.ingredients.length <= 3 ? 'F√°cil' : r.ingredients.length <= 5 ? 'Intermedio' : 'Avanzado';
                const timeEstimate = r.ingredients.length <= 3 ? '15 min' : r.ingredients.length <= 5 ? '30 min' : '45 min';
                
                el.innerHTML = `
                    <div class="recipe-header">
                        <div class="title">${r.title}</div>
                        <div class="recipe-badges">
                            <span class="badge badge-difficulty">${difficultyLevel}</span>
                            <span class="badge badge-time">‚è±Ô∏è ${timeEstimate}</span>
                        </div>
                    </div>
                    <div class="meta">
                        <strong>Ingredientes principales:</strong> ${r.ingredients.slice(0, 3).join(', ')}${r.ingredients.length > 3 ? '...' : ''}
                    </div>
                    <details class="toggle">
                        <summary>üìù Lista completa de ingredientes (${r.ingredients.length})</summary>
                        <ul>${r.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
                    </details>
                    <details class="toggle">
                        <summary>üë®‚Äçüç≥ Instrucciones paso a paso</summary>
                        <div class="instructions">${formatInstructions(r.instructions)}</div>
                    </details>
                `;
                recipesDiv.appendChild(el);
            });
        }
        
        function formatInstructions(instructions) {
            // Dividir por puntos y crear pasos numerados
            const steps = instructions.split(/\.\s+/).filter(step => step.trim().length > 0);
            if (steps.length <= 1) {
                return `<p><strong>1.</strong> ${instructions}</p>`;
            }
            
            return `
                <div class="recipe-steps">
                    ${steps.map((step, index) => `
                        <div class="step-item">
                            <strong>${index + 1}.</strong> ${step.trim()}${step.endsWith('.') ? '' : '.'}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Cargar recetas al inicializar la p√°gina
        loadRecipes();

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            // Confirmar antes de generar nuevas recetas (consume API key)
            const confirmed = confirm('¬øGenerar nuevas recetas? Esto consumir√° usos de la API de IA.');
            if (!confirmed) return;
            
            // Limpiar cach√© y cargar recetas frescas
            clearRecipesCache();
            await loadRecipes(true);
        });
    </script>
</body>

</html>